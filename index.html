<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Scheduler</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-card: #1e1e1e;
            --bg-hover: #252525;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent: #667eea;
            --accent-hover: #5568d3;
            --accent-light: rgba(102, 126, 234, 0.1);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #2a2a2a;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
        }

        .logo i {
            color: var(--accent);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 50px;
            border: 1px solid var(--border);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .btn-logout {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: white;
        }

        /* Auth Card */
        .auth-card {
            max-width: 500px;
            margin: 100px auto;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent), #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-card .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Navigation Tabs */
        .nav-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 14px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: var(--accent-light);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-block {
            width: 100%;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .file-upload-area i {
            font-size: 48px;
            color: var(--accent);
            margin-bottom: 10px;
        }

        #fileInput {
            display: none;
        }

        /* Image Preview Grid */
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .image-preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            cursor: move;
            transition: all 0.3s;
        }

        .image-preview-item:hover {
            transform: scale(1.05);
            border-color: var(--accent);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .image-preview-item.dragging {
            opacity: 0.5;
        }

        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            display: flex;
            justify-content: space-between;
            padding: 8px;
        }

        .image-preview-number {
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .btn-remove-image {
            background: var(--danger);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-remove-image:hover {
            transform: scale(1.1);
        }

        /* Task List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .task-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .task-status {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-scheduled {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-sent {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-paused {
            background: rgba(160, 160, 160, 0.2);
            color: var(--text-secondary);
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-body {
            margin-bottom: 12px;
        }

        .task-message {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 15px;
            line-height: 1.5;
        }

        .task-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-meta-item i {
            color: var(--accent);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .btn-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Info Box */
        .info-box {
            background: var(--accent-light);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-box i {
            color: var(--accent);
            font-size: 20px;
        }

        .info-box-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background: var(--accent-light);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            transition: 0.4s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--accent);
            border-color: var(--accent);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info h3 {
            font-size: 15px;
            margin-bottom: 4px;
        }

        .setting-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Loader */
        .loader {
            border: 3px solid var(--bg-secondary);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-container {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .task-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .image-preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
<!-- Auth Section -->
<div id="authSection" class="auth-card">
    <h1><i class="fab fa-telegram"></i> Telegram Scheduler</h1>
    <p class="subtitle">Schedule messages with media to your Telegram chats</p>
    <div id="alertBox"></div>

    <div class="form-group">
        <label>API ID</label>
        <input type="text" id="apiIdInput" placeholder="Enter your API ID">
    </div>

    <div class="form-group">
        <label>API Hash</label>
        <input type="text" id="apiHashInput" placeholder="Enter your API Hash">
    </div>

    <div class="form-group">
        <label>Phone Number</label>
        <input type="tel" id="phoneInput" placeholder="+1234567890">
    </div>

    <button class="btn btn-primary btn-block" onclick="startAuth()">
        <i class="fas fa-paper-plane"></i> Send Code
    </button>

    <div id="codeSection" class="hidden" style="margin-top:20px;">
        <div class="form-group">
            <label>Verification Code</label>
            <input type="text" id="codeInput" placeholder="Enter code from Telegram">
        </div>
        <button class="btn btn-primary btn-block" onclick="verifyCode()">
            <i class="fas fa-check"></i> Verify
        </button>
    </div>

    <div id="2faSection" class="hidden" style="margin-top:20px;">
        <div class="form-group">
            <label>2FA Password</label>
            <input type="password" id="passwordInput" placeholder="Enter your 2FA password">
        </div>
        <button class="btn btn-primary btn-block" onclick="verify2FA()">
            <i class="fas fa-unlock"></i> Submit
        </button>
    </div>
</div>

<!-- App Section -->
<div id="appSection" class="hidden">
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fab fa-telegram"></i>
                <span>Telegram Scheduler</span>
            </div>
            <div class="user-badge">
                <div class="user-avatar" id="userAvatar"></div>
                <div>
                    <div id="userName" style="font-weight:600;"></div>
                    <div style="font-size:12px;color:var(--text-secondary);" id="userTimezone"></div>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="nav-container">
            <button class="nav-tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="nav-tab" onclick="switchTab('schedule')">
                <i class="fas fa-plus-circle"></i> New Task
            </button>
            <button class="nav-tab" onclick="switchTab('tasks')">
                <i class="fas fa-list"></i> Tasks
            </button>
            <button class="nav-tab" onclick="switchTab('settings')">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </h2>
                </div>
                <div class="stats-grid" id="statsGrid">
                    <div class="loader"></div>
                </div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div id="scheduleTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-calendar-plus"></i> Schedule New Message
                    </h2>
                </div>

                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <div class="info-box-text">
                        All times are in your local timezone: <strong id="scheduleTimezoneInfo"></strong>
                    </div>
                </div>

                <div class="form-group">
                    <label>Schedule Type</label>
                    <select id="scheduleType" onchange="toggleScheduleFields()">
                        <option value="once">One-time</option>
                        <option value="repeat">Repeating</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Chats</label>
                    <select id="chatSelect" multiple style="height:160px;">
                    </select>
                    <button class="btn btn-secondary btn-sm" onclick="refreshChats()" style="margin-top:10px;">
                        <i class="fas fa-sync"></i> Refresh Chats
                    </button>
                </div>

                <div class="form-group">
                    <label>Message</label>
                    <textarea id="messageInput" placeholder="Enter your message here..."></textarea>
                </div>

                <div id="onceSchedule" class="form-group">
                    <label>Schedule Time (24-hour format)</label>
                    <input type="datetime-local" id="scheduleTime">
                </div>

                <div id="repeatSchedule" class="form-group hidden">
                    <label>Repeat Every</label>
                    <div style="display:flex;gap:10px;">
                        <input type="number" id="intervalValue" min="1" placeholder="Value" style="flex:1;">
                        <select id="intervalUnit" style="flex:1;">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                        </select>
                    </div>
                </div>

                <div id="autoDeleteSection" class="form-group">
                    <div class="setting-row">
                        <div class="setting-info">
                            <h3>Auto-delete after execution</h3>
                            <p>Automatically delete one-time tasks after they're sent</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoDeleteToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Attach Files</label>
                    <label for="fileInput" class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div style="color:var(--text-secondary);">Click to select images/videos (max 10)</div>
                        <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Drag images to reorder</div>
                    </label>
                    <input type="file" id="fileInput" multiple accept="image/*,video/*">
                    <div id="imagePreviewGrid" class="image-preview-grid"></div>
                </div>

                <button class="btn btn-success btn-block" onclick="submitForm()">
                    <i class="fas fa-paper-plane"></i> Schedule Message
                </button>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasksTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-tasks"></i> Your Tasks
                    </h2>
                </div>
                <div id="tasksList" class="task-list">
                    <div class="loader"></div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-cog"></i> Settings
                    </h2>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h3>Task Notifications</h3>
                        <p>Get notified via bot when tasks execute</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-edit"></i> Edit Task
            </h2>
            <button class="btn-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <input type="hidden" id="editTaskId">

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div class="info-box-text">
                Times are in your local timezone: <strong id="editTimezoneInfo"></strong>
            </div>
        </div>

        <div class="form-group">
            <label>Schedule Type</label>
            <select id="editScheduleType" onchange="toggleEditScheduleFields()">
                <option value="once">One-time</option>
                <option value="repeat">Repeating</option>
            </select>
        </div>

        <div class="form-group">
            <label>Select Chats</label>
            <select id="editChatSelect" multiple style="height:160px;"></select>
        </div>

        <div class="form-group">
            <label>Message</label>
            <textarea id="editMessageInput" placeholder="Enter your message here..."></textarea>
        </div>

        <div id="editOnceSchedule" class="form-group">
            <label>Schedule Time (24-hour format)</label>
            <input type="datetime-local" id="editScheduleTime">
        </div>

        <div id="editRepeatSchedule" class="form-group hidden">
            <label>Repeat Every</label>
            <div style="display:flex;gap:10px;">
                <input type="number" id="editIntervalValue" min="1" placeholder="Value" style="flex:1;">
                <select id="editIntervalUnit" style="flex:1;">
                    <option value="minutes">Minutes</option>
                    <option value="hours">Hours</option>
                    <option value="days">Days</option>
                </select>
            </div>
        </div>

        <div id="editAutoDeleteSection" class="form-group">
            <div class="setting-row">
                <div class="setting-info">
                    <h3>Auto-delete after execution</h3>
                    <p>Automatically delete one-time tasks after they're sent</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="editAutoDeleteToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>Attach Files</label>
            <label for="editFileInput" class="file-upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <div style="color:var(--text-secondary);">Click to select images/videos (max 10)</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Drag images to reorder</div>
            </label>
            <input type="file" id="editFileInput" multiple accept="image/*,video/*">
            <div id="editImagePreviewGrid" class="image-preview-grid"></div>
        </div>

        <div style="display:flex;gap:10px;">
            <button class="btn btn-success" style="flex:1;" onclick="updateTask()">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button class="btn btn-secondary" onclick="closeEditModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // --- Globals ---
    let selectedFiles = [];
    let editSelectedFiles = [];
    let pollingInterval = null;
    let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    let draggedIndex = null;

    // --- Utility Functions ---
    const showAlert = (msg, type='info') => {
        alertBox.innerHTML = `<div class="alert alert-${type}"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>${msg}</div>`;
        setTimeout(() => alertBox.innerHTML = '', 5000);
    };

    const toggleScheduleFields = () => {
        const isOnce = scheduleType.value === 'once';
        onceSchedule.classList.toggle('hidden', !isOnce);
        repeatSchedule.classList.toggle('hidden', isOnce);
        autoDeleteSection.classList.toggle('hidden', !isOnce);
    };

    const toggleEditScheduleFields = () => {
        const isOnce = editScheduleType.value === 'once';
        editOnceSchedule.classList.toggle('hidden', !isOnce);
        editRepeatSchedule.classList.toggle('hidden', isOnce);
        editAutoDeleteSection.classList.toggle('hidden', !isOnce);
    };

    const setMinDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 1);
        const min = now.toISOString().slice(0, 16);
        scheduleTime.min = min;
        editScheduleTime.min = min;
    };

    const fetchApi = async (endpoint, options={}) => {
        try {
            const r = await fetch(endpoint, options);
            const d = await r.json();
            if (!r.ok) throw new Error(d.error || 'API error');
            return d;
        } catch (e) {
            showAlert(e.message, 'error');
            throw e;
        }
    };

    const switchTab = (tab) => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + 'Tab').classList.add('active');

        if (tab === 'tasks') loadTasks(true);
        if (tab === 'dashboard') loadStats(true);
    };

    // --- Auth Functions ---
    const startAuth = async () => {
        await fetchApi('/api/auth/start', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ phone:phoneInput.value, api_id:apiIdInput.value, api_hash:apiHashInput.value })
        });
        showAlert('Code sent to Telegram!', 'success');
        codeSection.classList.remove('hidden');
    };

    const verifyCode = async () => {
        const d = await fetchApi('/api/auth/verify_code', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ code:codeInput.value })
        });
        if (d.needs_2fa) {
            showAlert('2FA required', 'info');
            document.getElementById('2faSection').classList.remove('hidden');
        } else if (d.success) showApp(d.user);
    };

    const verify2FA = async () => {
        const d = await fetchApi('/api/auth/verify_2fa', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ password:passwordInput.value })
        });
        if (d.success) showApp(d.user);
    };

    const logout = async () => {
        if (pollingInterval) clearInterval(pollingInterval);
        await fetchApi('/api/logout', { method:'POST' });
        window.location.reload();
    };

    // --- App Functions ---
    const showApp = (user) => {
        userName.textContent = user.first_name + (user.username ? ` (@${user.username})` : '');
        userAvatar.textContent = user.first_name[0].toUpperCase();
        userTimezone.textContent = userTimezone;
        scheduleTimezoneInfo.textContent = userTimezone;
        editTimezoneInfo.textContent = userTimezone;
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        loadInitialData();
        pollingInterval = setInterval(() => {
            if (document.getElementById('tasksTab').classList.contains('active')) loadTasks(false);
            if (document.getElementById('dashboardTab').classList.contains('active')) loadStats(false);
        }, 15000);
    };

    const loadInitialData = () => {
        loadChats();
        loadTasks(true);
        loadStats(true);
        loadNotificationSettings();
        setMinDateTime();
    };

    const loadChats = async (selectIds=[]) => {
        const d = await fetchApi('/api/chats');
        const html = d.chats.map(c => `<option value="${c.id}" ${selectIds.includes(c.id) ? 'selected' : ''}>${c.name}</option>`).join('');
        chatSelect.innerHTML = html;
        editChatSelect.innerHTML = html;
    };

    const refreshChats = async () => {
        showAlert('Refreshing chats...', 'info');
        await fetchApi('/api/chats/refresh', { method:'POST' });
        await loadChats();
        showAlert('Chats refreshed!', 'success');
    };

    const loadTasks = async (showLoader=false) => {
        if (showLoader) tasksList.innerHTML = '<div class="loader"></div>';
        const d = await fetchApi(`/api/tasks?timezone=${encodeURIComponent(userTimezone)}`);

        if (!d.tasks || d.tasks.length === 0) {
            tasksList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>No tasks yet</h3>
                    <p>Create your first scheduled message to get started</p>
                </div>
            `;
            return;
        }

        tasksList.innerHTML = d.tasks.map(t => {
            let scheduleText;
            if (t.schedule_type === 'repeat') {
                scheduleText = `Every ${t.interval_value} ${t.interval_unit}`;
            } else {
                const localDate = new Date(t.schedule_time);
                scheduleText = localDate.toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
            }

            let actions = `<button class="btn btn-secondary btn-sm" onclick="openEditModal('${t.id}')"><i class="fas fa-edit"></i> Edit</button>`;
            if (t.status === 'active' || t.status === 'scheduled') {
                actions += `<button class="btn btn-secondary btn-sm" onclick="pauseTask('${t.id}')"><i class="fas fa-pause"></i> Pause</button>`;
            }
            if (t.status === 'paused') {
                actions += `<button class="btn btn-success btn-sm" onclick="resumeTask('${t.id}')"><i class="fas fa-play"></i> Resume</button>`;
            }
            actions += `<button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')"><i class="fas fa-trash"></i> Delete</button>`;

            return `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-status status-${t.status}">${t.status}</span>
                        <div class="task-actions">${actions}</div>
                    </div>
                    <div class="task-body">
                        <div class="task-message">${t.message.substring(0, 120)}${t.message.length > 120 ? '...' : ''}</div>
                        <div class="task-meta">
                            <div class="task-meta-item">
                                <i class="far fa-clock"></i>
                                <span>${scheduleText}</span>
                            </div>
                            <div class="task-meta-item">
                                <i class="fas fa-users"></i>
                                <span>${t.chat_ids.length} chats</span>
                            </div>
                            ${t.files > 0 ? `
                                <div class="task-meta-item">
                                    <i class="fas fa-paperclip"></i>
                                    <span>${t.files} files</span>
                                </div>
                            ` : ''}
                            ${t.execution_count > 0 ? `
                                <div class="task-meta-item">
                                    <i class="fas fa-repeat"></i>
                                    <span>${t.execution_count}x executed</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    };

    const loadStats = async (showLoader=false) => {
        if (showLoader) statsGrid.innerHTML = '<div class="loader"></div>';
        const s = await fetchApi('/api/stats');
        statsGrid.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${s.total_tasks}</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.active_tasks}</div>
                <div class="stat-label">Active Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.completed_tasks}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${s.total_executions}</div>
                <div class="stat-label">Executions</div>
            </div>
        `;
    };

    const loadNotificationSettings = async () => {
        const s = await fetchApi('/api/settings/notifications');
        notificationsToggle.checked = s.enabled;
    };

    // --- Task Management ---
    const submitForm = async () => {
        const selectedChats = Array.from(chatSelect.selectedOptions).map(o=>o.value);
        if (selectedChats.length === 0) {
            showAlert('Please select at least one chat', 'error');
            return;
        }

        if (!messageInput.value.trim()) {
            showAlert('Please enter a message', 'error');
            return;
        }

        const fd = new FormData();
        fd.append('chat_ids', selectedChats.join(','));
        fd.append('message', messageInput.value);
        fd.append('schedule_type', scheduleType.value);
        fd.append('timezone', userTimezone);
        fd.append('auto_delete', autoDeleteToggle.checked ? 'true' : 'false');

        if (scheduleType.value === 'once') {
            if (!scheduleTime.value) {
                showAlert('Please select a schedule time', 'error');
                return;
            }
            fd.append('schedule_time', scheduleTime.value);
        } else {
            if (!intervalValue.value || intervalValue.value < 1) {
                showAlert('Please enter a valid interval', 'error');
                return;
            }
            fd.append('interval_value', intervalValue.value);
            fd.append('interval_unit', intervalUnit.value);
        }

        // Add file order
        const fileOrder = Array.from({length: selectedFiles.length}, (_, i) => i).join(',');
        fd.append('file_order', fileOrder);
        selectedFiles.forEach(f => fd.append('files', f));

        try {
            const r = await fetchApi('/api/schedule', { method:'POST', body:fd });
            showAlert(r.message, 'success');
            resetForm();
            loadTasks(true);
            loadStats(true);
            switchTab('tasks');
        } catch(e) {}
    };

    const resetForm = () => {
        messageInput.value = '';
        scheduleTime.value = '';
        intervalValue.value = '';
        chatSelect.selectedIndex = -1;
        selectedFiles = [];
        displayFiles();
        setMinDateTime();
        scheduleType.value = 'once';
        autoDeleteToggle.checked = false;
        toggleScheduleFields();
    };

    const openEditModal = async (id) => {
        const { task } = await fetchApi(`/api/tasks/${id}?timezone=${encodeURIComponent(userTimezone)}`);

        editTaskId.value = task.id;
        editMessageInput.value = task.message;
        editScheduleType.value = task.schedule_type;

        if (task.schedule_type === 'once') {
            if (task.schedule_time) {
                const localDate = new Date(task.schedule_time);
                const year = localDate.getFullYear();
                const month = String(localDate.getMonth() + 1).padStart(2, '0');
                const day = String(localDate.getDate()).padStart(2, '0');
                const hours = String(localDate.getHours()).padStart(2, '0');
                const minutes = String(localDate.getMinutes()).padStart(2, '0');
                editScheduleTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
        } else {
            editIntervalValue.value = task.interval_value;
            editIntervalUnit.value = task.interval_unit;
        }

        // Load chats and select
        await loadChats(task.chat_ids);
        Array.from(editChatSelect.options).forEach(opt => {
            opt.selected = task.chat_ids.includes(parseInt(opt.value));
        });

        // Load existing files
        editSelectedFiles = [];
        if (task.file_urls && task.file_urls.length > 0) {
            // Display existing files
            displayEditFiles(task.file_urls);
        } else {
            displayEditFiles([]);
        }

        toggleEditScheduleFields();
        editModal.classList.add('active');
    };

    const closeEditModal = () => {
        editModal.classList.remove('active');
        editSelectedFiles = [];
    };

    const updateTask = async () => {
        const id = editTaskId.value;
        const selectedChats = Array.from(editChatSelect.selectedOptions).map(o=>o.value);

        if (selectedChats.length === 0) {
            showAlert('Please select at least one chat', 'error');
            return;
        }

        if (!editMessageInput.value.trim()) {
            showAlert('Please enter a message', 'error');
            return;
        }

        const fd = new FormData();
        fd.append('chat_ids', selectedChats.join(','));
        fd.append('message', editMessageInput.value);
        fd.append('schedule_type', editScheduleType.value);
        fd.append('timezone', userTimezone);
        fd.append('auto_delete', editAutoDeleteToggle.checked ? 'true' : 'false');

        if (editScheduleType.value === 'once') {
            if (!editScheduleTime.value) {
                showAlert('Please select a schedule time', 'error');
                return;
            }
            fd.append('schedule_time', editScheduleTime.value);
        } else {
            if (!editIntervalValue.value || editIntervalValue.value < 1) {
                showAlert('Please enter a valid interval', 'error');
                return;
            }
            fd.append('interval_value', editIntervalValue.value);
            fd.append('interval_unit', editIntervalUnit.value);
        }

        // Add file order
        const fileOrder = Array.from({length: editSelectedFiles.length}, (_, i) => i).join(',');
        fd.append('file_order', fileOrder);
        editSelectedFiles.forEach(f => fd.append('files', f));

        try {
            const r = await fetchApi(`/api/tasks/${id}/update`, { method:'POST', body:fd });
            showAlert(r.message, 'success');
            closeEditModal();
            loadTasks(true);
            loadStats(true);
        } catch(e) {}
    };

    const deleteTask = async (id) => {
        if (!confirm('Are you sure you want to delete this task?')) return;
        await fetchApi(`/api/tasks/${id}`, {method:'DELETE'});
        showAlert('Task deleted successfully', 'success');
        loadTasks(true);
        loadStats(true);
    };

    const pauseTask = async (id) => {
        await fetchApi(`/api/tasks/${id}/pause`, {method:'POST'});
        showAlert('Task paused', 'success');
        loadTasks(true);
    };

    const resumeTask = async (id) => {
        await fetchApi(`/api/tasks/${id}/resume`, {method:'POST'});
        showAlert('Task resumed', 'success');
        loadTasks(true);
    };

    const toggleNotifications = async () => {
        const e = notificationsToggle.checked;
        await fetchApi('/api/settings/notifications', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({enabled:e})
        });
        showAlert(`Notifications ${e ? 'enabled' : 'disabled'}`, 'success');
    };

    // --- File Handling ---
    fileInput.addEventListener('change', e => {
        if (e.target.files.length > 10) {
            showAlert('Maximum 10 files allowed', 'error');
        }
        selectedFiles = Array.from(e.target.files).slice(0, 10);
        displayFiles();
    });

    editFileInput.addEventListener('change', e => {
        if (e.target.files.length > 10) {
            showAlert('Maximum 10 files allowed', 'error');
        }
        editSelectedFiles = Array.from(e.target.files).slice(0, 10);
        displayEditFiles();
    });

    const displayFiles = () => {
        if (selectedFiles.length === 0) {
            imagePreviewGrid.innerHTML = '';
            return;
        }

        imagePreviewGrid.innerHTML = selectedFiles.map((f, i) => {
            const url = URL.createObjectURL(f);
            const isVideo = f.type.startsWith('video/');
            return `
                <div class="image-preview-item" draggable="true" data-index="${i}" ondragstart="handleDragStart(event, ${i})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${i})" ondragend="handleDragEnd(event)">
                    ${isVideo ? `<video src="${url}" style="width:100%;height:150px;object-fit:cover;"></video>` : `<img src="${url}" alt="Preview">`}
                    <div class="image-preview-overlay">
                        <div class="image-preview-number">${i + 1}</div>
                        <button class="btn-remove-image" onclick="removeFile(${i})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    };

    const displayEditFiles = (existingUrls = null) => {
        if (editSelectedFiles.length === 0 && !existingUrls) {
            editImagePreviewGrid.innerHTML = '';
            return;
        }

        let files = editSelectedFiles;
        let urls = files.map(f => URL.createObjectURL(f));

        if (existingUrls && existingUrls.length > 0 && files.length === 0) {
            // Show existing files as preview only
            editImagePreviewGrid.innerHTML = existingUrls.map((url, i) => {
                const isVideo = url.toLowerCase().match(/\.(mp4|mov|avi|webm)$/);
                return `
                    <div class="image-preview-item">
                        ${isVideo ? `<video src="${url}" style="width:100%;height:150px;object-fit:cover;"></video>` : `<img src="${url}" alt="Preview">`}
                        <div class="image-preview-overlay">
                            <div class="image-preview-number">${i + 1}</div>
                            <div style="font-size:10px;color:white;padding:4px;">Existing</div>
                        </div>
                    </div>
                `;
            }).join('');
            return;
        }

        editImagePreviewGrid.innerHTML = urls.map((url, i) => {
            const f = files[i];
            const isVideo = f.type.startsWith('video/');
            return `
                <div class="image-preview-item" draggable="true" data-index="${i}" ondragstart="handleEditDragStart(event, ${i})" ondragover="handleDragOver(event)" ondrop="handleEditDrop(event, ${i})" ondragend="handleDragEnd(event)">
                    ${isVideo ? `<video src="${url}" style="width:100%;height:150px;object-fit:cover;"></video>` : `<img src="${url}" alt="Preview">`}
                    <div class="image-preview-overlay">
                        <div class="image-preview-number">${i + 1}</div>
                        <button class="btn-remove-image" onclick="removeEditFile(${i})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    };

    const removeFile = (i) => {
        selectedFiles.splice(i, 1);
        displayFiles();
    };

    const removeEditFile = (i) => {
        editSelectedFiles.splice(i, 1);
        displayEditFiles();
    };

    // --- Drag and Drop for reordering ---
    function handleDragStart(e, index) {
        draggedIndex = index;
        e.target.classList.add('dragging');
    }

    function handleEditDragStart(e, index) {
        draggedIndex = index;
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault();
    }

    function handleDrop(e, dropIndex) {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === dropIndex) return;

        const draggedFile = selectedFiles[draggedIndex];
        selectedFiles.splice(draggedIndex, 1);
        selectedFiles.splice(dropIndex, 0, draggedFile);
        displayFiles();
        draggedIndex = null;
    }

    function handleEditDrop(e, dropIndex) {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === dropIndex) return;

        const draggedFile = editSelectedFiles[draggedIndex];
        editSelectedFiles.splice(draggedIndex, 1);
        editSelectedFiles.splice(dropIndex, 0, draggedFile);
        displayEditFiles();
        draggedIndex = null;
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        draggedIndex = null;
    }

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const d = await fetchApi('/api/user/info');
            if (d.logged_in) showApp(d.user);
        } catch (e) {}
    });

    // Click outside modal to close
    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) closeEditModal();
    });

    // Initialize element references
    const elements = ['phoneInput','apiIdInput','apiHashInput','codeInput','passwordInput','codeSection','authSection','appSection','userName','userAvatar','statsGrid','notificationsToggle','scheduleType','chatSelect','messageInput','scheduleTime','onceSchedule','repeatSchedule','intervalValue','intervalUnit','fileInput','imagePreviewGrid','tasksList','alertBox','editModal','editTaskId','editScheduleType','editChatSelect','editMessageInput','editScheduleTime','editOnceSchedule','editRepeatSchedule','editIntervalValue','editIntervalUnit','editFileInput','editImagePreviewGrid','autoDeleteToggle','editAutoDeleteToggle','autoDeleteSection','editAutoDeleteSection'];
    elements.forEach(id => window[id] = document.getElementById(id));
</script>
</body>
</html>